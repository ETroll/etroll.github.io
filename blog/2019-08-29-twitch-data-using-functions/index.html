<!DOCTYPE html>
<html><head>
        <title>
            
                Trollcode.no - A personal blog
            
        </title>

    
    

    <link rel="stylesheet" href="//www.trollcode.no/sass/main.css">
</head><body><menu>
    <ul>
        <li>
            <a href="../../">Home</a>
        </li>
        
        <li>
            <a href="//www.trollcode.no/blog/">Blog</a>
        </li>
        
        <li>
            <a href="//www.trollcode.no/talk/">Talks</a>
        </li>
        
        <li>
            <a href="//www.trollcode.no/about/">About me</a>
        </li>
        
        <li>
            
                <a href="http://github.com/etroll">
                
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                </a>
            
                <a href="https://www.linkedin.com/in/karlsyvertloland/">
                
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                </a>
            
                <a href="https://stackoverflow.com/users/337544/etroll">
                
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Stack Overflow icon</title><path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189.451-2.07-10.478-2.187-.453 2.068zm1.359-5.056l9.705 4.53.903-1.95-9.706-4.53-.902 1.936v.014zm2.715-4.785l8.217 6.855 1.359-1.62-8.216-6.853-1.35 1.617-.01.001zM15.751 0l-1.746 1.294 6.405 8.604 1.746-1.294L15.749 0h.002z"/></svg>
                </a>
            
                <a href="https://t.me/ETroll">
                
                <svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Telegram icon</title><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg>
                </a>
            
                <a href="https://www.twitch.tv/karlonazure">
                
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitch icon</title><path d="M2.089 0L.525 4.175v16.694h5.736V24h3.132l3.127-3.132h4.695l6.26-6.258V0H2.089zm2.086 2.085H21.39v11.479l-3.652 3.652H12l-3.127 3.127v-3.127H4.175V2.085zM9.915 12.522H12v-6.26H9.915v6.26zm5.735 0h2.086v-6.26H15.65v6.26z"/></svg>
                </a>
            
                <a href="https://twitter.com/etroll">
                
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter icon</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
                </a>
            
        </li>
    </ul>

</menu>
<div id="content">
<div>
  <h1 class="blogpost">Getting viewer statistics from Twitch API using Azure Functions</h1>
  
  <h4 class="blogpost">August 31, 2019</h4>
  <span class="readingtime">Estimated reading time: 16 minutes</span>
  
  

  

<div class="github">
    <a href="https://github.com/ETroll/Twitch-api-function">
        <p >
            
This post has an associated public github repository. Check out the entire solution here on Github.

        </p>
    </a>
</div>


<p>I have live-coded a few times on Twitch now. And I think it is a great platform for both learning and trying to give back to the community by streaming and putting information out there for others to learn from. On Twitch all streams have to belong to one &ldquo;category&rdquo;. These categories are called games on Twitch. That is no real surprise, since it is a service created to stream yourself playing games. To accommodate people like me, Twitch have created a &ldquo;game&rdquo; called &ldquo;Science &amp; Technology&rdquo; where us that stream ourselves coding, creating electronics, doing chemistry experiments, etc. can stream our content. It is a game that has a small but very vocal viewership.</p>

<div class="blog-factbox">
    <div>
        
        <div class="blog-factbox-header">
            Twitch
        </div>
        
        <p>
            Twitch is a popular online service for watching and streaming digital video broadcasts. When it was founded in 2011, Twitch originally focused almost entirely on video games but has since expanded to include streams dedicated to artwork creation, music, talk shows, and the occasional TV series. (<a href="https://www.lifewire.com/what-is-twitch-4143337">Source</a>)
        </p>
    </div>
</div>

<p>What I want to create is a service that collects the numbers of viewers that this &ldquo;game&rdquo; has. And I will collect this number every hour. This is so that I can have a look at when I should be starting my own stream to get the best chance of getting viewed by someone &ldquo;swapping&rdquo; the channels. (I do not know if this will actually result to a higher amount of viewers, but hey, it is always fun to have an excuse for a new project to work on ;) )</p>

<h2 id="the-twitch-api">The Twitch API</h2>

<p>First thing we have to do is to have a look at the <a href="https://dev.twitch.tv/docs/api/">Twitch API</a>. The API is very nicely documented with a lot of sample code. So far it looks like that we have to read trough it to find a suiting API method to use. And we have to register our application so we can get access to the API.</p>

<p>You can register the application on the <a href="https://dev.twitch.tv/console/apps">Twitch developer dashboard</a> and get a client id and a client secret to use.</p>



<figure >
    
        <img src="TwitchDevConsole.png"  />
    
    
    <figcaption>
        <h4>The Twitch developer console</h4>
        
    </figcaption>
    
</figure>



<p>After reading trough the documentation I see that we need to do the following:</p>

<ol>
<li>Get the <code>game_id</code> for &ldquo;Science &amp; Technology&rdquo;</li>
<li>Get the number of viewers for this game</li>
</ol>

<p>We can get the <code>game_id</code> we need to use by calling the <a href="https://dev.twitch.tv/docs/api/reference/#get-games">Get Games</a> API method. As soon as we have this <code>game_id</code> we can use this with the <a href="https://dev.twitch.tv/docs/api/reference/#get-streams">Get Streams</a> API method to get information about the streams for the Science &amp; Technology &ldquo;game&rdquo;. I could not find any single API method that would just give me the count of the viewership of a particular game. I think this is something that should have been included in the response in the <code>Get Games</code> API method.</p>

<p>Anyhow, it looks like what we have to do to fulfill point number 2 in our list is to iterate tough all available streams for a game and sum the viewers. And since the API has very good pagination support this should not be to hard to do.</p>

<h2 id="creating-the-azure-function">Creating the Azure Function</h2>

<p>If you are not familiar about what Azure Functions is, then you can read my blogpost about it <a href="../../blog/2019-04-03-going-serverless-azure/">here</a>. Or you can go to Microsoft <a href="https://azure.microsoft.com/en-in/services/functions/">Azure Functions</a> page to read more about it.</p>

<p>So let just start with creating a new empty Azure Function. We will choose a <code>Timer trigger</code> function and use the storage emulator for local development. A <code>Timer trigger</code> function is executed at a given time interval set using <code>cron</code> like syntax. The defaults will execute our function every 5th minute.</p>

<p>NOTE: Azure Functions uses the <code>NCronTab</code> library to interpret NCRONTAB expressions. An <code>NCRONTAB</code> expression is similar to a CRON expression except that it includes an additional sixth field at the beginning to use for time precision in seconds.</p>



<figure >
    
        <img src="NewAzureFunction.png"  />
    
    
    <figcaption>
        <h4>Visual Studio 2019 - Create a new Azure Function screen</h4>
        
    </figcaption>
    
</figure>



<p>We then end up with the following function code to start with:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">Function1</span>
{
<span style="color:#309">    [FunctionName(&#34;Function1&#34;)]</span>
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">void</span> Run([TimerTrigger(<span style="color:#c30">&#34;0 */5 * * * *&#34;</span>)]TimerInfo myTimer, ILogger log)
    {
        log.LogInformation(<span style="color:#c30">$&#34;C# Timer trigger function executed at: {DateTime.Now}&#34;</span>);
    }
}
</code></pre></div>
<p>So first lets rename the function to something that suits us better. Let&rsquo;s say something like <code>TwitchViewersCollector</code> and let&rsquo;s set the trigger to trigger every hour. Then we will get data at a 1 hour granularity. I think that might be enough. Using the cron string <code>0 0 */1 * *</code> will execute the function every hour at the hour.</p>

<p>Next I want to have a binding to a <code>Azure Table Storage</code> in our function. This is for storing the viewer count. I could have stored this data in a Azure SQL Server, PostgreSQL or any other relational database. But for simplicity and cost using the Azure Table Storage key-value store is good enough and <em>very</em> cheap.</p>

<p>Azure Functions support many input and output bindings. Previously in version 1 of Azure Functions you did not need to use a library or nuget package to make use of a binding. It was &ldquo;baked in&rdquo; the Azure Function. But now in version 2 we have to use a <code>NuGet</code> package.</p>

<p>So setting up a binding to a Azure Table Storage is easy enough. We just have to get the following NuGet package: <code>Microsoft.Azure.WebJobs.Extensions.Storage</code>.</p>

<p>We then have to add the following as a parameter to the function: <code>[Table(&quot;ScitechViewers&quot;)] IAsyncCollector&lt;ViewersTableEntity&gt; viewersTable</code>. This makes the function pass a pointer to a table storage as a parameter when it gets executed. We can then use this to access the table storage and add a new row to the table storage.</p>

<p>We have to define a class that inherits from <code>TableEntity</code>. This class represents the row in the table storage we want to insert. Since we only want to insert a number of viewers we can just create the following class:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">ViewersTableEntity</span> : TableEntity
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">int</span> Viewers { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
</code></pre></div>
<p>And to insert a row into the table storage we just have to write the following code snippet inside the function block:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">await</span> viewersTable.AddAsync(<span style="color:#069;font-weight:bold">new</span> ViewersTableEntity
{
    PartitionKey = timestamp.ToString(<span style="color:#c30">&#34;yyyy-MM-dd&#34;</span>),
    RowKey = timestamp.Hour.ToString(),
    Viewers = <span style="color:#f60">0</span>
});
</code></pre></div>
<p>This creates a new row with the amount of viewers to 0 for now. We use day as a <code>PartitionKey</code> and the hour as a <code>RowKey</code>. For more information about what PartitionKey and RowKey is you can have a look at the documentation here: <a href="https://docs.microsoft.com/en-us/rest/api/storageservices/understanding-the-table-service-data-model">Understanding the Table Service Data Model</a> Using these as the keys might not be the most efficient. But for this use-case it is good enough.</p>

<p>The function so far should look like this and not do much more than add a viewer count of 0 every hour to the table storage:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchViewersCollector</span>
{
<span style="color:#309">    [FunctionName(&#34;TwitchViewersCollector&#34;)]</span>
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">async</span> Task Run(
<span style="color:#309">        [TimerTrigger(&#34;0 0 */1 * * *&#34;, RunOnStartup = true)]</span>TimerInfo myTimer, 
<span style="color:#309">        [Table(&#34;ScitechViewers&#34;)]</span> IAsyncCollector&lt;ViewersTableEntity&gt; viewersTable, 
        ILogger log)
    {
        log.LogInformation(<span style="color:#c30">$&#34;C# Timer trigger function executed at: {DateTime.Now}&#34;</span>);

        DateTime timestamp = DateTime.UtcNow;

        <span style="color:#069;font-weight:bold">await</span> viewersTable.AddAsync(<span style="color:#069;font-weight:bold">new</span> ViewersTableEntity
        {
            PartitionKey = timestamp.ToString(<span style="color:#c30">&#34;yyyy-MM-dd&#34;</span>),
            RowKey = timestamp.Hour.ToString(),
            Viewers = <span style="color:#f60">0</span>
        });
    }
}

<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">ViewersTableEntity</span> : TableEntity
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">int</span> Viewers { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
</code></pre></div>
<p>Running this function locally would work just fine. But for it to work &ldquo;out-of-the-box&rdquo; you have to start the local <code>Azure Storage Emulator</code> that ships with Visual Studio. If you are not using Visual Studio you can download it <a href="https://go.microsoft.com/fwlink/?linkid=717179&amp;clcid=0x409">here</a>. You can also read more about its usage here: <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-use-emulator">Use the Azure storage emulator for development and testing</a>. By default Azure Functions set the following as <code>AzureWebJobsStorage</code> in the local.settings.json file: <code>UseDevelopmentStorage=true</code> Using this connection string will let Azure Functions use the storage emulator without the need to use the connection string one normally would need to use when using the local storage emulator.</p>

<h2 id="get-data-using-the-twitch-api">Get data using the Twitch API</h2>

<p>So let&rsquo;s get our hands a bit dirty with this API that is the main course of this article. Earlier we identified that we needed to use the <code>Get Games</code> and <code>Get Streams</code> API calls. So let&rsquo;s get our <code>Client Id</code> from the App we registered in the Twitch developer console earlier.</p>

<p>To use the API we can ether use our Client Id directly and get limited to <em>30 calls per minute</em> against 800 per minute if we authenticate and use a Bearer token. (<a href="https://dev.twitch.tv/docs/api/guide/#rate-limits">ref</a>) For this small application I will no bother to authenticate and accept the 30 per minute limit. It is good enough for this. But for any real and serious use of the Twitch API one should authenticate. Maybe we will do it if we enhance the application to fetch more data later.</p>

<p>First thing we have to do is to get the <code>game_id</code> for the &ldquo;Science &amp; Technology&rdquo; game. According to the documentation this is a easy <code>GET</code> request and can be called using Curl like this:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#c30">&#39;Client-ID: uo6dggojyb8d6soh92zknwmi5ej1q2&#39;</span> <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>      -X GET <span style="color:#c30">&#39;https://api.twitch.tv/helix/games?name=Science%20%26%20Technology&#39;</span>

RESULT:
<span style="color:#555">{</span>
    <span style="color:#c30">&#34;data&#34;</span>: <span style="color:#555">[</span>
        <span style="color:#555">{</span>
            <span style="color:#c30">&#34;id&#34;</span>: <span style="color:#c30">&#34;509670&#34;</span>,
            <span style="color:#c30">&#34;name&#34;</span>: <span style="color:#c30">&#34;Science \u0026 Technology&#34;</span>,
            <span style="color:#c30">&#34;box_art_url&#34;</span>: <span style="color:#c30">&#34;https://static-cdn.jtvnw.net/ttv-boxart/Science%20\u0026%20Technology-{width}x{height}.jpg&#34;</span>
        <span style="color:#555">}</span>
    <span style="color:#555">]</span>
<span style="color:#555">}</span></code></pre></div>
<p>The game_id is the <code>id</code> value in the game object inside the data array. So lets do this call in our function. We will create a setting to store our game name. Lets call that <code>TWITCH_GAME_NAME</code>. And let&rsquo;s also store our Client Id in the setting. Lets call that <code>TWITCH_CLIENT_ID</code>.</p>

<p>Our local.settings.json should now look like:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#309;font-weight:bold">&#34;IsEncrypted&#34;</span>: <span style="color:#069;font-weight:bold">false</span>,
    <span style="color:#309;font-weight:bold">&#34;Values&#34;</span>: {
        <span style="color:#309;font-weight:bold">&#34;AzureWebJobsStorage&#34;</span>: <span style="color:#c30">&#34;UseDevelopmentStorage=true&#34;</span>,
        <span style="color:#309;font-weight:bold">&#34;FUNCTIONS_WORKER_RUNTIME&#34;</span>: <span style="color:#c30">&#34;dotnet&#34;</span>,
        <span style="color:#309;font-weight:bold">&#34;TWITCH_CLIENT_ID&#34;</span>:  <span style="color:#c30">&#34;&#34;</span>,
        <span style="color:#309;font-weight:bold">&#34;TWITCH_GAME_NAME&#34;</span>: <span style="color:#c30">&#34;Science &amp; Technology&#34;</span>
    }
}</code></pre></div>
<p>Note that the <code>TWITCH_CLIENT_ID</code> is empty here. That is because I do not want to give you readers my client id. ;) You can add your client id there, or use an Environment Variable with the same name when developing. When we are deploying this to Azure we will add this client id to the Azure Function using the Azure Portal. (A better way would be to use <code>Managed Identities</code> and store secrets in the <code>Azure Key Vault</code> but we will not be covering this now.)</p>

<p>So lets call the Twitch API and see if we get a game_id back. To do this we will be using the <code>HttpClient</code> class. A bit if a caution: I have used this class inside a <code>using</code> statement. This is not the best way to use it. This class intended to be created once and re-used. But since we are writing a Azure Function here, and that function is ephemeral, I have just done the easy thing and wrapped inside a basically not needed using statement. But the following code will get the data from the API:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">using</span> (<span style="color:#078;font-weight:bold">var</span> client = <span style="color:#069;font-weight:bold">new</span> HttpClient())
{
    client.DefaultRequestHeaders.Add(<span style="color:#c30">&#34;Client-ID&#34;</span>, clientId);
    client.BaseAddress = <span style="color:#069;font-weight:bold">new</span> Uri(<span style="color:#c30">&#34;https://api.twitch.tv&#34;</span>);

    HttpResponseMessage gamesHttpResult = <span style="color:#069;font-weight:bold">await</span> client.GetAsync(<span style="color:#c30">$&#34;helix/games?name={Uri.EscapeDataString(gameName)}&#34;</span>);
    <span style="color:#078;font-weight:bold">string</span> gameContent = <span style="color:#069;font-weight:bold">await</span> gamesHttpResult.Content.ReadAsStringAsync();
    TwitchResult&lt;TwitchGame&gt; gameResult = JsonConvert.DeserializeObject&lt;TwitchResult&lt;TwitchGame&gt;&gt;(gameContent);
    log.LogInformation(gameContent);
}
</code></pre></div>
<p>So lets just parse the data and use the returned game_id to further call <code>Get Streams</code> so we can get the real data we want. The Get Streams API call is paginated so we need to look for the pagination cursor and follow that if it is set. We then have to sum all the counts together. But that should be easy enough. We will create a loop that continues as long as there is a pagination cursor to follow or we have hit a &ldquo;breaker&rdquo; limit. (So we don&rsquo;t fall into a infinite loop.) The loop itself will use the same <code>HttpClient</code> that we used for the Get Games call. So the code will be very similar. I will not paste this code snipped alone here. But below you can se it as a part of the entire function code I have pasted.</p>

<p>Now, since both our tasks that we wanted to accomplish have been solved. We now have a Azure Function that will get the number of viewers on a given &ldquo;game&rdquo; every hour for us. The following code is the entire function code we have created until now:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchViewersCollector</span>
{
<span style="color:#309">    [FunctionName(&#34;TwitchViewersCollector&#34;)]</span>
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">async</span> Task Run(
<span style="color:#309">        [TimerTrigger(&#34;0 0 */1 * * *&#34;, RunOnStartup = true)]</span>TimerInfo myTimer, 
<span style="color:#309">        [Table(&#34;ScitechViewers&#34;)]</span> IAsyncCollector&lt;ViewersTableEntity&gt; viewersTable, 
        ILogger log)
    {
        log.LogInformation(<span style="color:#c30">$&#34;C# Timer trigger function executed at: {DateTime.Now}&#34;</span>);

        <span style="color:#078;font-weight:bold">string</span> clientId = Environment.GetEnvironmentVariable(<span style="color:#c30">&#34;TWITCH_CLIENT_ID&#34;</span>);
        <span style="color:#078;font-weight:bold">string</span> gameName = Environment.GetEnvironmentVariable(<span style="color:#c30">&#34;TWITCH_GAME_NAME&#34;</span>);

        <span style="color:#069;font-weight:bold">if</span>(!<span style="color:#078;font-weight:bold">string</span>.IsNullOrWhiteSpace(clientId) &amp;&amp; !<span style="color:#078;font-weight:bold">string</span>.IsNullOrWhiteSpace(gameName))
        {
            <span style="color:#069;font-weight:bold">using</span> (<span style="color:#078;font-weight:bold">var</span> client = <span style="color:#069;font-weight:bold">new</span> HttpClient())
            {
                client.DefaultRequestHeaders.Add(<span style="color:#c30">&#34;Client-ID&#34;</span>, clientId);
                client.BaseAddress = <span style="color:#069;font-weight:bold">new</span> Uri(<span style="color:#c30">&#34;https://api.twitch.tv&#34;</span>);
                HttpResponseMessage gamesHttpResult = 
                    <span style="color:#069;font-weight:bold">await</span> client.GetAsync(<span style="color:#c30">$&#34;helix/games?name={Uri.EscapeDataString(gameName)}&#34;</span>);

                <span style="color:#069;font-weight:bold">if</span>(!gamesHttpResult.IsSuccessStatusCode)
                {
                    log.LogError(<span style="color:#c30">$@&#34;Twitch API call (Get Games) was not 
</span><span style="color:#c30">                        successful. HTTP CODE: {gamesHttpResult.StatusCode}&#34;</span>);
                    <span style="color:#069;font-weight:bold">return</span>;
                }
                <span style="color:#069;font-weight:bold">try</span>
                {
                    <span style="color:#078;font-weight:bold">string</span> gameContent = <span style="color:#069;font-weight:bold">await</span> gamesHttpResult.Content.ReadAsStringAsync();
                    TwitchResult&lt;TwitchGame&gt; gameResult = 
                        JsonConvert.DeserializeObject&lt;TwitchResult&lt;TwitchGame&gt;&gt;(gameContent);

                    <span style="color:#069;font-weight:bold">if</span>(gameResult.Data.Count &gt; <span style="color:#f60">0</span>)
                    {
                        <span style="color:#078;font-weight:bold">string</span> gameId = gameResult.Data[<span style="color:#f60">0</span>].Id;

                        <span style="color:#078;font-weight:bold">int</span> sum = <span style="color:#f60">0</span>;
                        <span style="color:#078;font-weight:bold">int</span> breaker = <span style="color:#f60">0</span>;
                        <span style="color:#078;font-weight:bold">string</span> cursor = <span style="color:#078;font-weight:bold">string</span>.Empty;

                        <span style="color:#069;font-weight:bold">while</span>(breaker &lt; <span style="color:#f60">20</span>) <span style="color:#09f;font-style:italic">//There should not be more than 20 pages.. I think..
</span><span style="color:#09f;font-style:italic"></span>                        {
                            <span style="color:#078;font-weight:bold">string</span> afterString = <span style="color:#078;font-weight:bold">string</span>.Empty;
                            <span style="color:#069;font-weight:bold">if</span>(!<span style="color:#078;font-weight:bold">string</span>.IsNullOrWhiteSpace(cursor))
                            {
                                afterString = <span style="color:#c30">$&#34;&amp;after={cursor}&#34;</span>;
                            }

                            HttpResponseMessage streamsResult = 
                                <span style="color:#069;font-weight:bold">await</span> client.GetAsync(<span style="color:#c30">$&#34;helix/streams?first=100&amp;game_id={gameId}{afterString}&#34;</span>);
                            <span style="color:#069;font-weight:bold">if</span> (!streamsResult.IsSuccessStatusCode)
                            {
                                log.LogError(<span style="color:#c30">$@&#34;Twitch API call (Get Streams) 
</span><span style="color:#c30">                                    was not successful. HTTP CODE: {streamsResult.StatusCode}&#34;</span>);
                                <span style="color:#069;font-weight:bold">return</span>;
                            }

                            <span style="color:#078;font-weight:bold">string</span> streamResultContent = <span style="color:#069;font-weight:bold">await</span> streamsResult.Content.ReadAsStringAsync();
                            TwitchResult&lt;TwitchStream&gt; streamResult = 
                                JsonConvert.DeserializeObject&lt;TwitchResult&lt;TwitchStream&gt;&gt;(streamResultContent);
                            <span style="color:#069;font-weight:bold">if</span> (streamResult?.Data.Count &gt; <span style="color:#f60">0</span>)
                            {
                                <span style="color:#069;font-weight:bold">foreach</span>(<span style="color:#078;font-weight:bold">var</span> stream <span style="color:#069;font-weight:bold">in</span> streamResult.Data)
                                {
                                    sum += stream.Viewer_count;
                                }
                            }
                            <span style="color:#069;font-weight:bold">if</span>(streamResult?.Pagination.Cursor == <span style="color:#069;font-weight:bold">null</span>)
                            {
                                <span style="color:#069;font-weight:bold">break</span>;
                            }
                            <span style="color:#069;font-weight:bold">else</span>
                            {
                                cursor = streamResult.Pagination.Cursor;
                            }
                            breaker++;
                        }

                        DateTime timestamp = DateTime.UtcNow;
                        <span style="color:#069;font-weight:bold">await</span> viewersTable.AddAsync(<span style="color:#069;font-weight:bold">new</span> ViewersTableEntity
                        {
                            PartitionKey = timestamp.ToString(<span style="color:#c30">&#34;yyyy-MM-dd&#34;</span>),
                            RowKey = timestamp.Hour.ToString(),
                            Viewers = sum
                        });
                    }
                    <span style="color:#069;font-weight:bold">else</span>
                    {
                        log.LogWarning(<span style="color:#c30">$&#34;No gamed with the name {gameName} found&#34;</span>);
                    }
                }
                <span style="color:#069;font-weight:bold">catch</span>(Exception ex)
                {
                    log.LogError(ex, <span style="color:#c30">&#34;Could not parse results from Twitch&#34;</span>);
                }
            }
        }
        <span style="color:#069;font-weight:bold">else</span>
        {
            log.LogError(<span style="color:#c30">&#34;ClientId or Game Name was not found. Exiting.&#34;</span>);
        }
    }
}

<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">ViewersTableEntity</span> : TableEntity
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">int</span> Viewers { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchResult</span>&lt;T&gt;
{
    <span style="color:#069;font-weight:bold">public</span> List&lt;T&gt; Data { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> TwitchPagination Pagination { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchPagination</span>
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Cursor { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchGame</span>
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Id { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Name { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Box_art_url { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">TwitchStream</span>
{
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Id { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> User_id { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> User_name { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Game_id { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Type { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Title { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">int</span> Viewer_count { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Started_at { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Language { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">string</span> Thumbnail_url { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
    <span style="color:#069;font-weight:bold">public</span> List&lt;<span style="color:#078;font-weight:bold">string</span>&gt; Tag_ids { <span style="color:#069;font-weight:bold">get</span>; <span style="color:#069;font-weight:bold">set</span>; }
}
</code></pre></div>
<h2 id="deploying-to-azure">Deploying to Azure</h2>

<p>Now we have our function. So how shall we deploy this to Microsoft Azure? There are a few ways to do this. You can do it manually via the Azure Portal, CLI or Powershell. Or you can do it directly from Visual Studio. You can also deploy using one of many CI/CD solutions that supports Microsoft Azure.</p>

<p>For this function I will just use the simplest option: Deploy from Visual Studio. But before we deploy to Azure you need to have a Azure subscription that you can deploy to. If you do not already have a subscription you can get a promotional &ldquo;Azure Free&rdquo; subscription right here at: <a href="https://azure.microsoft.com/en-us/free/">Create your Azure free account</a>. Even tough the name have the word &ldquo;free&rdquo; in it, it is not really free. It is just some services that you can get for free. But what is good about this offer is the USD 200 that you get to play around with. And you can test out a lot of Azure services for that amount.</p>



<figure >
    
        <img src="Publish.png"  />
    
    
    <figcaption>
        <h4>The Visual Studio Publish window</h4>
        
    </figcaption>
    
</figure>



<p>So, back to deploying. Now that you have a subscription ready to deploy to. You can right click on the project in Visual Studio and choose: <code>Publish</code>. A new windows should appear. For solution the defaults should suffice, so press &ldquo;Publish&rdquo; again in the window. The defaults we just said &ldquo;yes&rdquo; to is that we will create a new Azure Function Consumption plan where we just pay for every execution of the function. We get a hefty free-tier to play around with every month on the consumption plan. So for this project the cost will be Zero for the Azure Function. We do however have to pay for the storage, but that will be a miniscule amount. For more information about the consumption plan and its pricing you can go <a href="https://azure.microsoft.com/en-us/pricing/details/functions/">here</a>.</p>

<p>For the next window you can also use the defaults if you like. But if you want to choose where in the world the function should be deployed and what resource group it should use. Then this is where you choose this. We will not go into what resource groups are here in this article. Nor will we explain where to best put your function based on from where it will be used. So if this is something you do not know much about, then use the default for this deployment and we can learn about those things at a later time. :)</p>



<figure >
    
        <img src="Publish2.png"  />
    
    
    <figcaption>
        <h4>The Visual Studio Publish window - Choose region and resource group</h4>
        
    </figcaption>
    
</figure>



<p>When you now press the &ldquo;Create&rdquo; button, Visual Studio will create the resources in your Azure subscription. So when this is complete we will have to navigate to the Azure Portal to input our two settings that we need to be in place. The <code>TWITCH_GAME_NAME</code> and the <code>TWITCH_CLIENT_ID</code> settings. So lets go the <a href="https://portal.azure.com">Azure Portal</a> now.</p>

<p>Navigate to the Azure Function you just created by pressing the &ldquo;Resource Groups&rdquo; menu and choose the resource group we just created.</p>



<figure >
    
        <img src="Portal1.png"  />
    
    
    <figcaption>
        <h4>Azure Portal resource group list</h4>
        
    </figcaption>
    
</figure>



<p>When you open the resource group there should be a list of resources. Click on the Azure Function resource. You will then get to the Azure Function interface where we can see all about our Azure Function. Click on the &ldquo;Platform Features&rdquo; and choose &ldquo;Configuration&rdquo; from the menu that is opened.</p>



<figure >
    
        <img src="Portal2.png"  />
    
    
    <figcaption>
        <h4>Azure Function platform features view</h4>
        
    </figcaption>
    
</figure>



<p>In the Application Settings windows we can add two new application settings by pressing the &ldquo;New application setting&rdquo; button. Here we can add the setting and the value we need. So create a new setting named <code>TWITCH_CLIENT_ID</code> and insert your Twitch application client id. And then create a setting named <code>TWITCH_GAME_NAME</code> and insert <code>Science &amp; Technology</code> as a value.</p>



<figure >
    
        <img src="Portal3.png"  />
    
    
    <figcaption>
        <h4>Azure Function platform features view</h4>
        
    </figcaption>
    
</figure>



<p>The Azure Function is now ready to do its job. And we are done :)</p>

<p>Since we did not use a specific connection string to the table storage we used in our function binding, Azure Functions will use the same Azure Storage Account that itself are stored in. During the deployment process a Azure Storage Account was created. And we can now go and see if there are any data in the table storage the function will create in that account. When the function was created it did not have the necessary settings, failed. So we have to press &ldquo;Restart&rdquo; in the Azure Functions pane in the Azure Portal. This will make the function restart. And since we have the flag <code>RunOnStartup</code> set in the function, the function will execute. So we do not have to wait until next hour to see if it worked.</p>



<figure >
    
        <img src="StorageExplorer.png"  />
    
    
    <figcaption>
        <h4>Azure Storage Explorer</h4>
        
    </figcaption>
    
</figure>



<p>The best way to look at the data using a UI is trough the Azure Storage Explorer. This is a application available in the Azure Portal as well as a standalone application you can <a href="https://azure.microsoft.com/en-us/features/storage-explorer/">download</a> to your PC or Mac. I recommend to have this application installed when you are working with Azure Storage Account. It makes life a lot easier.</p>

<p>And using the storage explorer we can now see that it was 925 in the Science &amp; Technology &ldquo;game&rdquo; when we now tested. So it all works :) Great! Now we can collect data for some time and see if there is a time of day and day of week where there are more viewers than other times. But that result is for another article in the future.</p>

</div>


        </div><footer>
    <div>
        &copy; 2014 - 2019 Karl Syvert LÃ¸land - All Rights Reserved
    </div>
</footer>
    </body>
</html>
